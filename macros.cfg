#####################################################################
#  Macros
#####################################################################
[gcode_macro PREP]
gcode:
    {% set bed_temp = params.BED|default(100)|float %}
    {% set extruder_temp = params.EXTRUDER|default(220)|float %}
    {% set chamber_temp = params.CHAMBER|default(40)|float %}
    {% set soak_mins = params.SOAK_MINS|default(30)|float %}

[gcode_macro PRINT_START]
gcode:
    {% set bed_temp = params.BED|default(100)|float %}
    {% set extruder_temp = params.EXTRUDER|default(220)|float %}
    {% set chamber_temp = params.CHAMBER|default(40)|float %}
    # {% set soak_mins = params.SOAK_MINS|default(30)|float %}
    BED_MESH_CLEAR                 ; clear mesh
    SET_FRAME_COMP ENABLE=1
    _CG28                          ; Home the printer
    G90                            ; Use absolute coordinates
    PARKCENTER                     ; Move to center
    M117 Heating..
    M106 S255                      ; set print fan to full speed
    M140 S{bed_temp}               ; Start bed heating
    M190 S{bed_temp}               ; Wait for bed to reach temperature
    # G4 P{soak_mins * 60000}
    TEMPERATURE_WAIT SENSOR='temperature_sensor chamber' MINIMUM={chamber_temp}
    M117 soaking for {soak_mins} min(s)...
    M117
    QUAD_GANTRY_LEVEL CALIBRATE=false ; QGL
    G28 Z
    M109 S{extruder_temp}          ; Set and wait for nozzle to reach temperature
    clean_nozzle                   ; clean nozzle
    CALIBRATE_Z
    BED_MESH_PROFILE LOAD=default  ; load mesh
    M107                           ; turn print fan off
    M117

[gcode_macro PRINT_END]
gcode:
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-10.0 F3600                ; retract filament
    G91                            ; relative positioning
    G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G1 Z2 F3000                    ; move nozzle up 2mm
    G90                            ; absolute positioning
    PARKREAR
    BED_MESH_CLEAR
    M117 Done!

[gcode_macro PARKCENTER]
gcode:
    {% set Z = params.Z|default(30)|float %}
    SAVE_GCODE_STATE NAME=PARKCENTER_state
    _CG28                          ; Home if not already homed
    G90                            ; absolute positioning
    G0 X175 Y175 Z{Z} F12000       ; move to center
    RESTORE_GCODE_STATE NAME=PARKCENTER_state

[gcode_macro PARKREAR]
gcode:
    SAVE_GCODE_STATE NAME=PARKREAR_state
    _CG28                          ; Home if not already homed
    G90                            ; absolute positioning
    G0 X310 Y350 F12000       ; move to center
    RESTORE_GCODE_STATE NAME=PARKREAR_state

[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
default_parameter_X: 310    #edit to your park position
default_parameter_Y: 350    #edit to your park position
default_parameter_Z: 10     #edit to your park position
default_parameter_E: 1      #edit to your retract length
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{E} F2100
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F6000

[gcode_macro RESUME]
rename_existing: BASE_RESUME
default_parameter_E: 1      #edit to your retract length
gcode:
    G91
    G1 E{E} F2100
    G90
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    BASE_RESUME

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT

[gcode_macro FANCY_MESH]
gcode:
    {% set bed_temp = params.BED|default(110)|float %}
    {% set extruder_temp = params.EXTRUDER|default(140)|float %}
    {% set chamber_temp = params.CHAMBER|default(48)|float %}
    # {% set soak_mins = params.SOAK_MINS|default(30)|float %}
    BED_MESH_CLEAR                 ; clear mesh
    SET_FRAME_COMP ENABLE=1
    _CG28                          ; Home the printer
    G90                            ; Use absolute coordinates
    PARKCENTER                     ; Move to center
    M117 Heating..
    M106 S255                      ; set print fan to full speed
    M140 S{bed_temp}               ; Start bed heating
    M190 S{bed_temp}               ; Wait for bed to reach temperature
    # G4 P{soak_mins * 60000}
    TEMPERATURE_WAIT SENSOR='temperature_sensor chamber' MINIMUM={chamber_temp}
    M117 soaking for {soak_mins} min(s)...
    M117
    QUAD_GANTRY_LEVEL CALIBRATE=false ; QGL
    G28 Z
    M109 S{extruder_temp}          ; Set and wait for nozzle to reach temperature
    clean_nozzle                   ; clean nozzle
    BED_MESH_CALIBRATE
    M117
    M400                           ; wait for buffer to clear
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G90                            ; absolute positioning
    PARKREAR
    SAVE_CONFIG

[gcode_macro PID_HEATER_TUNE]
gcode:
    {% set bed_temp = params.BED|default(110)|float %}
    BED_MESH_CLEAR                 ; clear mesh
    _CG28                          ; Home the printer
    G90                            ; Use absolute coordinates
    PARKCENTER                     ; Move to center
    M117 Heating..
    M106 S255                      ; set print fan to full speed
    PID_CALIBRATE HEATER=heater_bed TARGET={bed_temp}
    M117
    M400                           ; wait for buffer to clear
    TURN_OFF_HEATERS
    M107                           ; turn off fan
    G90                            ; absolute positioning
    PARKREAR
    SAVE_CONFIG

[gcode_macro QUICK_MESH]
gcode:
    BED_MESH_CLEAR                 ; clear mesh
    _CG28                          ; Home the printer
    SET_FRAME_COMP ENABLE=1
    QUAD_GANTRY_LEVEL CALIBRATE=false ; QGL
    G28 Z
    BED_MESH_CALIBRATE
    PARKREAR
    G0 Z30

[frame_expansion_compensation]
coeff: 23.4
#   Coefficient of linear expansion for the frame material [μm/m·°C].
#   E.g. 23.4 μm/m·°C for Misumi A6N01SS-T5 6005A-T5 aluminum alloy.
frame_z_length: 530
#   Total length of vertical extrusions [mm].
gantry_factor: 0.19
#   Relationship between gantry expansion and toolhead Z movement.
#   Examples:
#      if 1mm expansion moves toolhead up 1mm, gantry_factor: 1.0
#      if 1mm expansion moves toolhead up 0.5mm, gantry_factor: 0.5
#      if 1mm expansion moves toolhead down 1mm, gantry_factor: -1.0
#   The default is 1.0.
#max_comp_z:
#   Disables compensation above this Z height [mm]. The last computed correction
#   will remain applied until the toolhead moves below the specified Z position
#   again. The default is 0.0mm (always on).
#max_z_offset:
#   Maximum absolute compensation that can be applied to the Z axis [mm]. The
#   default is 99999999.0mm (unlimited).
sensor_type: 100k3950
sensor_pin: P0.23
min_temp: 0
max_temp: 100
#   See the "extruder" section for the definition of the above
#   parameters.
gcode_id: frame
#   See the "heater_generic" section for the definition of this
#   parameter.
z_stepper: stepper_z
#   The Z stepper motor linked with the Z endstop, as written in printer.cfg.
#   Used for triggering reference temperature measurement. Usually 'stepper_z'
#   unless otherwise defined.

[include homing.cfg]
[include probing.cfg]
[include nozzle_clean.cfg]